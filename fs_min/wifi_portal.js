var WiFiPortal={SSIDs:[],Networks:[],_msg_proto:function(e){return{$el:document.getElementById(e),show:function(e){this.$el.innerHTML=e,this.$el.style.display="block"},hide:function(){this.$el.style.display="none"}}},init:function(){WiFiPortal.Buttons.init(),WiFiPortal.Info=new WiFiPortal._msg_proto("info"),WiFiPortal.Error=new WiFiPortal._msg_proto("error"),document.getElementById("networks").onchange=function(e){var t=this.value||this.options[this.selectedIndex].value;WiFiPortal.selectNetwork(t)},document.getElementById("networks").onblur=function(e){var t=this.value||this.options[this.selectedIndex].value;WiFiPortal.selectNetwork(t)},WiFiPortal.check(function(e){WiFiPortal.rescan()},!1)},check:function(o,r){WiFiPortal.Buttons.disableAll("Please wait, checking..."),WiFiPortal.rpcCall("GET","Sys.GetInfo",r||!1,!1,function(e){var t,i="Error";i=e&&!0!==e?(t=e.wifi||e,t=JSON.stringify(t,void 0,2),WiFiPortal.highlight(t)):"Imposible recuperar la informaci√≥n",document.getElementById("response").innerHTML=i||"",r||WiFiPortal.Buttons.enableAll(),"function"==typeof o&&o(e)})},Info:{},Error:{},Timers:{clear:function(){WiFiPortal.Timers.Test.remove(),WiFiPortal.Timers.Timeout.remove()},Timeout:{_id:!1,init:function(){WiFiPortal.Timers.Timeout.remove(),WiFiPortal.Timers.Timeout._id=setTimeout(WiFiPortal.Test.timeout,1e3*WiFiPortal.Test._timeout+2e3)},remove:function(){WiFiPortal.Timers.Timeout._id&&(clearTimeout(WiFiPortal.Timers.Timeout._id),WiFiPortal.Timers.Timeout._id=!1)}},Test:{_id:!1,init:function(){WiFiPortal.Timers.Test.remove(),WiFiPortal.Timers.Test._id=setTimeout(WiFiPortal.Test.check,1e3*WiFiPortal.Test._interval)},remove:function(){WiFiPortal.Timers.Test._id&&(clearTimeout(WiFiPortal.Timers.Test._id),WiFiPortal.Timers.Test._id=!1)}}},Buttons:{_proto:function(e,t){e=document.getElementById(e);return e&&e.addEventListener("click",t),{$el:e,preVal:!1,update:function(e){this.$el.innerHTML=e},disable:function(e){this.preVal||(this.preVal=this.$el.innerHTML),this.update(e),this.$el.disabled=!0},enable:function(){this.preVal&&(this.$el.innerHTML=this.preVal,this.preVal=!1),this.$el.disabled=!1}}},_all:{},_ids:["rescan","save","check"],init:function(){for(var e=0;e<WiFiPortal.Buttons._ids.length;e++){var t=WiFiPortal.Buttons._ids[e];WiFiPortal.Buttons._all[t]=new WiFiPortal.Buttons._proto(t,WiFiPortal[t])}},enableAll:function(){for(var e in WiFiPortal.Buttons._all)WiFiPortal.Buttons._all[e].enable()},disableAll:function(e){for(var t in WiFiPortal.Buttons._all)WiFiPortal.Buttons._all[t].disable(e)}},Test:{_timeout:30,_checks:0,_interval:5,success:!1,timedout:!1,ssid:!1,init:function(){WiFiPortal.Test._checks=0,WiFiPortal.Test.success=!1,WiFiPortal.Test.timedout=!1,setTimeout(WiFiPortal.Test.check,900),WiFiPortal.Timers.Timeout.init()},timeout:function(){var e;WiFiPortal.Test.success||(WiFiPortal.Test.timedout=!0,WiFiPortal.Error.show("Tiempo excedido despu√©s de "+WiFiPortal.Test._timeout+" segundos. Por favor, revisa el SSID y la contrase√±a y vuelve a intentarlo."),WiFiPortal.Info.hide(),(e=document.getElementById("response"))&&(e.innerHTML="")),WiFiPortal.Timers.clear(),WiFiPortal.Buttons.enableAll()},check:function(){WiFiPortal.check(function(e){var t,i="Error";e&&!0!==e?e.wifi?(t=JSON.stringify(e.wifi,void 0,2),document.getElementById("response").innerHTML=WiFiPortal.highlight(t),e.wifi.status&&e.wifi.ssid&&("got ip"===e.wifi.status&&e.wifi.ssid===WiFiPortal.Test.ssid?(WiFiPortal.Test.success=!0,WiFiPortal.Error.hide(),WiFiPortal.Info.show("¬°Conexi√≥n a la WiFi completada! Conectado a "+e.wifi.ssid),WiFiPortal.Buttons.enableAll(),WiFiPortal.Timers.clear()):i="Estado de la conexi√≥n WiFi: "+e.wifi.status)):i="Recibida respuesta, error obteniendo el estado de la WiFi":(WiFiPortal.Info.hide(),WiFiPortal.Error.show("Error obteniendo el estado de la WiFi, probando otra vez en 5 segundos...")),WiFiPortal.Test._checks++,WiFiPortal.Test.success||WiFiPortal.Test.timedout||(WiFiPortal.Error.hide(),WiFiPortal.Info.show(i+", check "+WiFiPortal.Test._checks+", volviendolo a intentar en "+WiFiPortal.Test._interval+" segundos..."),WiFiPortal.Timers.Test.init())},"Obteniendo el estado de la WiFi...")}},save:function(){var e=document.getElementById("networks").value,t=document.getElementById("password").value,i=document.getElementById("puser").value;if(!e||e.length<1)return WiFiPortal.Info.hide(),void WiFiPortal.Error.show("Tienes que seleccionar el SSID del desplegable!");WiFiPortal.Buttons.disableAll("Por favor espera, enviando..."),WiFiPortal.Test.ssid=e,WiFiPortal.rpcCall("POST","WiFi.PortalTest","Enviando credenciales al dispositivo para probarlas...",{ssid:e,pass:t,user:i},function(e){e&&!0!==e&&void 0!==e.result?!1===e.result?(WiFiPortal.Error.show("!Error del dispositivo al configurar la WiFi! Comprueba el SSID y la contrase√±a y vu√©lvelo a intentar!"),WiFiPortal.Buttons.enableAll()):(WiFiPortal.Error.hide(),WiFiPortal.Info.show("El dispositivo est√° probando la conexi√≥n WiFi, por favor espera..."),WiFiPortal.Test.init()):(WiFiPortal.Error.show("Error enviando credenciales al dispositivo, por favor, int√©ntalo de nuevo"),WiFiPortal.Buttons.enableAll()),document.body.scrollTop=document.documentElement.scrollTop=0})},rescan:function(){WiFiPortal.Buttons.disableAll("Buscando..."),WiFiPortal.rpcCall("POST","WiFi.PortalScan","Buscando redes wifi en rango...",!1,function(e){var r;e&&0<e.length?(WiFiPortal.SSIDs=[],WiFiPortal.Networks=[],(r=document.getElementById("networks")).removeAttribute("disabled"),r.innerHTML='<option value="-1" disabled="disabled" selected="selected">Por favor, selecciona un SSID...</option>',e.forEach(function(e){var t,i,o;-1<WiFiPortal.SSIDs.indexOf(e.ssid)||(t=document.createElement("option"),o="OPEN",1===(i=parseInt(e.auth))?o="WEP":2===i?o="WPA/PSK":3===i?o="WPA2/PSK":4===i?o="WPA/WPA2/PSK":5===i&&(o="WPA2/ENT"),t.innerHTML=(0<i?"üîí ":"üîì ")+WiFiPortal.rssiToStrength(e.rssi)+"% - "+e.ssid+" ("+o+")",t.value=e.ssid,r.appendChild(t),WiFiPortal.SSIDs.push(e.ssid),WiFiPortal.Networks.push(e))}),WiFiPortal.Info.show("Por favor, selecciona una de las "+WiFiPortal.SSIDs.length+" redes encontradas.")):(WiFiPortal.Info.hide(),WiFiPortal.Error.show("Ningna red encontrada, prueba otra vez...")),WiFiPortal.Buttons.enableAll()})},rpcCall:function(e,t,i,o,r){if(!(httpRequest=new XMLHttpRequest))return WiFiPortal.Error.show("Unable to create an XMLHttpRequest, try to manually set"),r(!1);void 0!==i&&i&&WiFiPortal.Info.show(i),httpRequest.onreadystatechange=function(){if(httpRequest.readyState!==XMLHttpRequest.DONE)return!1;var e;200!==httpRequest.status?httpRequest.responseText&&0<httpRequest.responseText.length?(WiFiPortal.Error.show("Error del dispositivo ( "+httpRequest.responseText+" ) -- Prueba otra vez"),r(!0)):r(!1):(e=JSON.parse(httpRequest.responseText),r(e))},httpRequest.open(e,"/rpc/"+t),httpRequest.setRequestHeader("Content-Type","application/json"),httpRequest.send(JSON.stringify(o))},rssiToStrength:function(e){return quality=0===e||e<=-100?0:-50<=e?100:2*(e+100)},highlight:function(e){return(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})},selectNetwork:function(t){var i=document.getElementById("passwrap"),o=document.getElementById("peapuserwrap"),r=(document.getElementById("networks"),!(o.style.display="none"));WiFiPortal.Networks.forEach(function(e){if(e.ssid===t)return e=parseInt(e.auth),0===e?i.style.display="none":5===e?(i.style.display="block",o.style.display="block"):i.style.display="block",!(r=!0)}),r||(i.style.display="block")}};document.addEventListener("DOMContentLoaded",WiFiPortal.init);