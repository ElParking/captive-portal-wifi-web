var WiFiPortal={_msg_proto:function(t){return{$el:document.getElementById(t),show:function(t){this.$el.innerHTML=t,this.$el.style.display="block"},hide:function(){this.$el.style.display="none"}}},init:function(){WiFiPortal.Buttons.init(),WiFiPortal.Info=new WiFiPortal._msg_proto("info"),WiFiPortal.Error=new WiFiPortal._msg_proto("error"),WiFiPortal.check(function(t){console.log("Info response",t),WiFiPortal.rescan()},!1)},check:function(r,s){WiFiPortal.Buttons.disableAll("Please wait, checking..."),WiFiPortal.rpcCall("GET","Sys.GetInfo",s||!1,!1,function(t){var i="Error";if(t&&!0!==t){var e=t.wifi?t.wifi:t,o=JSON.stringify(e,void 0,2);i=WiFiPortal.highlight(o)}else i="Unable to get info from device";document.getElementById("response").innerHTML=i||"",s||WiFiPortal.Buttons.enableAll(),"function"==typeof r&&r(t)})},Info:{},Error:{},Timers:{clear:function(){WiFiPortal.Timers.Test.remove(),WiFiPortal.Timers.Timeout.remove()},Timeout:{_id:!1,init:function(){WiFiPortal.Timers.Timeout.remove(),WiFiPortal.Timers.Timeout._id=setTimeout(WiFiPortal.Test.timeout,1e3*WiFiPortal.Test._timeout+2e3)},remove:function(){WiFiPortal.Timers.Timeout._id&&(clearTimeout(WiFiPortal.Timers.Timeout._id),WiFiPortal.Timers.Timeout._id=!1)}},Test:{_id:!1,init:function(){WiFiPortal.Timers.Test.remove(),WiFiPortal.Timers.Test._id=setTimeout(WiFiPortal.Test.check,1e3*WiFiPortal.Test._interval)},remove:function(){WiFiPortal.Timers.Test._id&&(clearTimeout(WiFiPortal.Timers.Test._id),WiFiPortal.Timers.Test._id=!1)}}},Buttons:{_proto:function(t,i){var e=document.getElementById(t);return e&&e.addEventListener("click",i),{$el:e,preVal:!1,update:function(t){this.$el.innerHTML=t},disable:function(t){this.preVal||(this.preVal=this.$el.innerHTML),this.update(t),this.$el.disabled=!0},enable:function(){this.preVal&&(this.$el.innerHTML=this.preVal,this.preVal=!1),this.$el.disabled=!1}}},_all:{},_ids:["rescan","save","check"],init:function(){for(var t=0;t<WiFiPortal.Buttons._ids.length;t++){var i=WiFiPortal.Buttons._ids[t];WiFiPortal.Buttons._all[i]=new WiFiPortal.Buttons._proto(i,WiFiPortal[i])}},enableAll:function(){for(var t in WiFiPortal.Buttons._all)WiFiPortal.Buttons._all[t].enable()},disableAll:function(t){for(var i in WiFiPortal.Buttons._all)WiFiPortal.Buttons._all[i].disable(t)}},Test:{_timeout:30,_checks:0,_interval:5,success:!1,timedout:!1,ssid:!1,init:function(){WiFiPortal.Test._checks=0,WiFiPortal.Test.success=!1,WiFiPortal.Test.timedout=!1,setTimeout(WiFiPortal.Test.check,900),WiFiPortal.Timers.Timeout.init()},timeout:function(){if(!WiFiPortal.Test.success){WiFiPortal.Test.timedout=!0,WiFiPortal.Error.show("Test has timed out after "+WiFiPortal.Test._timeout+" seconds. Please check the SSID and Password and try again."),WiFiPortal.Info.hide();var t=document.getElementById("response");t&&(t.innerHTML="")}WiFiPortal.Timers.clear(),WiFiPortal.Buttons.enableAll()},check:function(){WiFiPortal.check(function(t){var i="Error";if(t&&!0!==t)if(t.wifi){var e=JSON.stringify(t.wifi,void 0,2);document.getElementById("response").innerHTML=WiFiPortal.highlight(e),t.wifi.status&&t.wifi.ssid&&("got ip"===t.wifi.status&&t.wifi.ssid===WiFiPortal.Test.ssid?(WiFiPortal.Test.success=!0,WiFiPortal.Error.hide(),WiFiPortal.Info.show("WiFi connection successful! Connected to "+t.wifi.ssid),WiFiPortal.Buttons.enableAll(),WiFiPortal.Timers.clear()):i="WiFi current status is "+t.wifi.status)}else i="Received response, error getting WiFi status";else WiFiPortal.Info.hide(),WiFiPortal.Error.show("Error getting WiFi status, trying again in 5 seconds...");WiFiPortal.Test._checks++,WiFiPortal.Test.success||WiFiPortal.Test.timedout||(WiFiPortal.Error.hide(),WiFiPortal.Info.show(i+", check "+WiFiPortal.Test._checks+", trying again in "+WiFiPortal.Test._interval+" seconds..."),WiFiPortal.Timers.Test.init())},"Checking device WiFi status...")}},save:function(){var t=document.getElementById("networks").value,i=document.getElementById("password").value;if(!t||t.length<1)return WiFiPortal.Info.hide(),void WiFiPortal.Error.show("You must select an SSID from the dropdown!");WiFiPortal.Buttons.disableAll("Please wait, sending..."),WiFiPortal.Test.ssid=t,WiFiPortal.rpcCall("POST","WiFi.PortalSave","Sending credentials to device to test...",{ssid:t,pass:i},function(t){t&&!0!==t&&void 0!==t.result?!1===t.result?(WiFiPortal.Error.show("Error from device setting up STA! Check SSID and Password and try again!"),WiFiPortal.Buttons.enableAll()):(WiFiPortal.Error.hide(),WiFiPortal.Info.show("Device is testing WiFi connection, please wait..."),WiFiPortal.Test.init()):(WiFiPortal.Error.show("Error sending credentials to device, please try again"),WiFiPortal.Buttons.enableAll())})},rescan:function(){WiFiPortal.Buttons.disableAll("Scanning..."),WiFiPortal.rpcCall("POST","WiFi.PortalScan","Scanning for WiFi networks in range of device...",!1,function(t){if(t&&0<t.length){var e=document.getElementById("networks");e.removeAttribute("disabled"),e.innerHTML='<option value="-1" disabled="disabled" selected="selected">Please select an SSID...</option>';var o=[];t.forEach(function(t){if(!(-1<o.indexOf(t.ssid))){var i=document.createElement("option");i.innerHTML=t.ssid+" ("+t.bssid+") - "+WiFiPortal.rssiToStrength(t.rssi)+"% / "+t.rssi,i.value=t.ssid,e.appendChild(i),o.push(t.ssid)}}),WiFiPortal.Info.show("Please select from one of the "+t.length+" WiFi networks found.")}else WiFiPortal.Info.hide(),WiFiPortal.Error.show("No networks found, try again...");WiFiPortal.Buttons.enableAll()})},rpcCall:function(t,i,e,o,r){if(httpRequest=new XMLHttpRequest,!httpRequest)return WiFiPortal.Error.show("Unable to create an XMLHttpRequest, try to manually set"),r(!1);void 0!==e&&e&&WiFiPortal.Info.show(e),httpRequest.onreadystatechange=function(){if(httpRequest.readyState!==XMLHttpRequest.DONE)return console.log("rpcCall httpRequest readyState is NOT done!",httpRequest.readyState),!1;if(200!==httpRequest.status)return console.log("rpcCall httpRequest status is NOT 200!",httpRequest),void(httpRequest.responseText&&0<httpRequest.responseText.length?(WiFiPortal.Error.show("Error from device ( "+httpRequest.responseText+" ) -- Please try again"),r(!0)):r(!1));console.log("responseText",httpRequest.responseText);var t=JSON.parse(httpRequest.responseText);console.log("httpResponse",t),r(t)},httpRequest.open(t,"/rpc/"+i),httpRequest.setRequestHeader("Content-Type","application/json"),httpRequest.send(JSON.stringify(o))},rssiToStrength:function(t){return quality=0===t||t<=-100?0:-50<=t?100:2*(t+100),quality},highlight:function(t){return(t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(t){var i="number";return/^"/.test(t)?i=/:$/.test(t)?"key":"string":/true|false/.test(t)?i="boolean":/null/.test(t)&&(i="null"),'<span class="'+i+'">'+t+"</span>"})}};document.addEventListener("DOMContentLoaded",WiFiPortal.init);